## class file format



`classFile`Structure



```c
ClassFile {
    u4             magic;
    u2             minor_version;
    u2             major_version;
    u2             constant_pool_count;
    cp_info        constant_pool[constant_pool_count-1];
    u2             access_flags;
    u2             this_class;
    u2             super_class;
    u2             interfaces_count;
    u2             interfaces[interfaces_count];
    u2             fields_count;
    field_info     fields[fields_count];
    u2             methods_count;
    method_info    methods[methods_count];
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
```





| name                | description  |
| ------------------- | ------------ |
| magic               | 模数         |
| minor_version       |              |
| major_version       |              |
| constant_pool_count |              |
| constant_pool       | 从1开始      |
| access_flags        | 访问控制标记 |



access flag

| flag name      | value  | interpretation                                               |
| -------------- | ------ | ------------------------------------------------------------ |
| ACC_PUBLIC     | 0x0001 |                                                              |
| ACC_FINAL      | 0x0010 |                                                              |
| ACC_SUPER      | 0x0020 |                                                              |
| ACC_INTERFACE  | 0x0200 |                                                              |
| ACC_ABSTRACT   | 0x0400 |                                                              |
| ACC_SYNTHETIC  | 0x1000 | indicates that this field was generated by a compiler<br/>and does not appear in source code. |
| ACC_ANNOTATION | 0x2000 |                                                              |
| ACC_ENUM       | 0x4000 |                                                              |
|                |        |                                                              |

may have at most one of its ACC_PUBLIC, ACC_PRIVATE, and ACC_PROTECTED flags set.

must not have both its ACC_FINAL and ACC_VOLATILE flags set.





| name             | description                                              |
| ---------------- | -------------------------------------------------------- |
| this_class       |                                                          |
| super_class      |                                                          |
| interface_count  |                                                          |
| interfaces[]     | 记录位于constant_pool里的位置，类型是CONSTANT_Class_info |
| fields_count     |                                                          |
| fields[]         | field_info数组                                           |
| methods_count    |                                                          |
| methods[]        |                                                          |
| attributes_count |                                                          |
| attributes[]     |                                                          |



疑问：field和attribute有什么区别？





名称的内部结构

.分割变成了/分割

```
Java.lang.Thread
>
java/lang/Thread
```



描述符

是什么？

字符串，代表field或者方法。



Field 描述符

```sh
FieldDescriptor:
	FieldType

FieldType:
	BaseType
	ObjecType
	ArrayType
	
BaseType:
	(one of)
	B C D F I J S Z
ObjecType:
	L ClassName;

ArrayType:
	[ ComponentType

ComponentType:
	FieldType
```



| FiledType term | type      | interpretation      |
| -------------- | --------- | ------------------- |
| B              | byte      |                     |
| C              | char      |                     |
| D              | double    |                     |
| F              | float     |                     |
| I              | int       |                     |
| J              | long      | long integer        |
| L ClassName;   | reference |                     |
| S              | short     |                     |
| Z              | boolean   | true or false       |
| [              | reference | one array dimension |





method descriptor

> A method descriptor contains zero or more parameter descriptors, representing the
> types of parameters that the method takes, and a return descriptor, representing the
> type of the value (if any) that the method returns.



```sh
MethodDescriptor:
({ParameterDescriptor}) ReturnDescriptor

ParameterDescritor:
	FieldType
ReturnDesscriptor:
	FiledType
	VoidDescriptor
VoidDescriptor:
	V
```



example

```java
Object m(int i,double d, Thread t){...}

is 
    
(IDLjava/lang/Thread;)LJava/lang/Object;
```



constraint

parameters is total length of 255 or less. long and double contribute two units.





The Constant Pool



general format

```c
cp_info {
	u1 tag;
	u1 info[]
}
```



constant pool tags

| Type                        | value |
| --------------------------- | ----- |
| CONSTANT_Class              | 7     |
| CONSTANT_Fieldref           | 9     |
| CONSTANT_Methodref          | 10    |
| CONSTANT_InterfaceMethodref | 11    |
| CONSTANT_String             | 8     |
| CONSTANT_Integer            | 3     |
| CONSTANT_Float              | 4     |
| CONSTANT_Long               | 5     |
| CONSTANT_Double             | 6     |
| CONSTANT_NameAndType        | 12    |
| CONSTANT_Utf8               | 1     |
| CONSTANT_MethodHandle       | 15    |
| CONSTANT_MethodType         | 16    |
| CONSTANT_InvokeDynamic      | 18    |



CONSTANT_Class_info

```c
CONSTANT_Class_info{
    u1 tag;
    u2 name_index;
}
```

tag is 7, name_index is a valid index in constant_pool





The `CONSTANT_Fieldref_info`, `CONSTANT_Methodref_info`, and`CONSTANT_InterfaceMethodref_info` Structures

```c++
CONSTANT_Fieldref_info {
    u1 tag; // 9
    u2 class_index;
    u2 name_and_type_index;  // index in constant pool, with CONSTANT_NameAndType_info field descriptor
}
CONSTANT_Methodref_info {
    u1 tag;  // 10
    u2 class_index;
    u2 name_and_type_index; // method descriptor
}
CONSTANT_InterfaceMethodref_info {
    u1 tag;  // 11
    u2 class_index;
    u2 name_and_type_index;
}
```



`CONSTANT_String_info`

```c
CONSTANT_String_info {
    u1 tag; // 8
    u2 string_index; // CONSTANT_Utf8_info in constant_pool
}
```



`CONSTANT_Integer_info` and `CONSTANT_Float_info`

4-byte numeric 

```c
CONSTANT_Integer_info {
    u1 tag; // 3
    u4 bytes; // big-endian (high byte first) order.
}
CONSTANT_Float_info {
    u1 tag; // 4
    u4 bytes; // IEEE 754 floating-point single format, big-endian order
}
```





 `CONSTANT_Long_info` and `CONSTANT_Double_info`

 8-byte numeric, take two entries in the constant_pool

```c
CONSTANT_Long_info {
    u1 tag; // 5
    u4 high_bytes;
    u4 low_bytes;
}
CONSTANT_Double_info {
    u1 tag; // 6
    u4 high_bytes;
    u4 low_bytes;
}
```

equal to 

((long) high_bytes << 32) + low_bytes



` CONSTANT_NameAndType_info`

 used to represent a field or method

```c
CONSTANT_NameAndType_info {
    u1 tag; // 12
    u2 name_index;  // index in constant_pool point to CONSTANT_Utf8_info, special method or valid unqualified name denoting field or method
    u2 descriptor_index; // CONSTANT_Utf8_info, a valid field descriptor or method
}
```



`CONSTANT_Utf8_info`

represent constant string values

```c
CONSTANT_Utf8_info {
    u1 tag; // 1
    u2 length; 
    u1 bytes[length];
}
```



`CONSTANT_MethodHandle_info`

 represent a method handle

```c
CONSTANT_MethodHandle_info {
    u1 tag; // 15
    u1 reference_kind; // in  the  range  1  to  9
    u2 reference_index; //  index  into  the constant_pool
}
```



reference_index

-  CONSTANT_Fieldref_info
  - reference_kind
    - 1 REF_getField
    - 2 REF_getStatic
    - 3 REF_putField
    - 4 REF_putStatic
-  CONSTANT_Methodref_info
  - class's method or constructor
  - reference_kind
    - 5 REF_invokeVirtual
    - 8 REF_newInvokeSpecial
- CONSTANT_Methodref_info
  - version number < 52.0
  - reference_kind
    - 6 REF_invokeStatic
    - 7 REF_invokeSpecial
  - version number >= 52.0
    - CONSTANT_InterfaceMethodref_info or CONSTANT_Methodref_info
- CONSTANT_InterfaceMethodref_info
  - 9  REF_invokeInterface



`CONSTANT_MethodType_info `

represent a method type

```c
CONSTANT_MethodType_info {
    u1 tag; //16
    u2 descriptor_index; // CONSTANT_Utf8_info
}			
```



`CONSTANT_InvokeDynamic_info`

used  by  an  invokedynamic instruction  (invokedynamic)  to  specify  a  bootstrap  method

```c
CONSTANT_InvokeDynamic_info {
    u1 tag; // 18
    u2 bootstrap_method_attr_index; //  bootstrap_methods array of the bootstrap method table
    u2 name_and_type_index; // CONSTANT_NameAndType_info
}
```



Fields

No two fields in one class file may have the same name and descriptor

```c
field_info {
    u2             access_flags;
    u2             name_index;  // constant pool index point to CONSTANT_Utf8_info
    u2             descriptor_index; // same as
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
```





Methods

including each instance initialization method and the class or interface initialization method



```c
method_info {
    u2             access_flags;
    u2             name_index;
    u2             descriptor_index;
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
```



Attributes

> used  in  the  ClassFile,  field_info,  method_info,  and Code_attribute structures of the class file format



```c
attribute_info {
    u2 attribute_name_index; //  CONSTANT_Utf8_info
    u4 attribute_length;
    u1 info[attribute_length];
}
```

