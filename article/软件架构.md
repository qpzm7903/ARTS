# 软件架构

## 13 全局事务和共享事务

## 14 分布式事务

多个服务、多个数据源

分布式环境下的事务处理机制

CAP定理：一个分布式系统中， 涉及到共享数据问题时，一下三个特性最多满足两个

- 一致性 consistency：
  - 任何时刻、分布式节点中，我们看到的数据时没有矛盾的
  - 和ACID中的C不是一个意义。ACID中的C要以这个C为前提
- 可用性 available
  - 不间断提供服务的能力
- 分区容忍性 partition tolerance
  - 分布式环境中，部分节点失联，系统也能提供服务

PA是现在分布式事务的主流实现。因为A是分布式的目的



## 15 分布式事务之TCC与SAGA

TCC

- Try：尝试，获取所有资源，然后预留资源
- Confirm：用上一个阶段的资源进行业务处理，可能会重复执行，所以要求幂等性
- Cancel：取消执行，释放资源，也可能重复，需要幂等性



缺点

- 业务侵入性强
- 更高的开发成本
- 所需要的资源都要预留

优点

- 不涉及锁，性能好



第三个缺点中，如果涉及外界资源，就不能用了。比如支付系统中，直接调用第三方的支付，就不能用这个。

SAGA

基于数据补偿代替回滚

1、大事务拆成若干小事务

2、每个小事务涉及对应的补偿动作



要求

- 小事务和补偿动作具备幂等性
- 满足交换律，小事务和补偿动作执行不区分先后
- 补偿动作必须能提交



补偿的意思就是，补偿比撤销容易实现。比如银行转账后很难撤销，但是可以再转回去



AT事务





## 16 域名解析系统，优化HTTP性能的第一步

系统架构、多级分流

减少单点部件，减少到达单点部件得流量

DNS 的作用是把便于人类理解的域名地址，转换为便于计算机处理的 IP 地址

DNS 是以存活时间（Time to Live，TTL）来衡量缓存的有效情况的



## 17客户端缓存怎么帮助服务器分担流量







